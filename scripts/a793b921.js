let e="";const t=document.querySelector("#i"),n=document.querySelector("#o"),c=document.querySelector("#w"),o=document.querySelector("#l"),i=document.querySelector("#_"),r=document.querySelector("#k"),s=document.querySelector("#x");async function u(){if(e)return{success:!0,publicKey:e};try{const t=await fetch("/api/getPublicKey",{method:"GET"}),n=await t.json();return e=n.publicKey,{success:!0,publicKey:e}}catch(e){return{success:!1,publicKey:null}}}function a(){return{key:window.forge.random.getBytesSync(32),iv:window.forge.random.getBytesSync(16)}}function l(e,t,n){const c=window.forge.cipher.createCipher("AES-CBC",t);return c.start({iv:n}),c.update(window.forge.util.createBuffer(e)),c.finish(),c.output.toHex()}function d(e,t){const n=window.forge.pki.publicKeyFromPem(t);return window.forge.util.encode64(n.encrypt(e,"RSA-OAEP"))}function y(e="t"){"show"===e?(r.classList.add("iq"),s.textContent="Sending..."):(r.classList.remove("iq"),s.textContent="Send message")}function f(e="",t=0){setTimeout((()=>{alert(e)}),t)}t.addEventListener("submit",(async function(e){e.preventDefault();try{const e=n.value,r=c.value,s=o.value,w=i.checked;if(r.length>100)return void f("Subject cannot exceed 100 characters.");if(s.length>500)return void f("Message cannot exceed 500 characters.");if(!w)return void f("Please accept the Terms of Service and Privacy Policy before submitting.");y("show");const m=await u();if(!m.success)throw new Error("Failed to fetch public key");const{key:g,iv:h}=a(),p=l(JSON.stringify({email:e,subject:r,message:s}),g,h),S=d(g,m.publicKey),b=d(h,m.publicKey),v=await fetch(t.action,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:p+"."+S+"."+b})}),q=await v.json();y("t"),f(q.message,50),"success"===q.status&&t.reset()}catch(e){f("Something went wrong. Please try again.")}finally{y("t")}}));