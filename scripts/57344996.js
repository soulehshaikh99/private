let e="";const t=document.querySelector("#s"),n=document.querySelector("#o"),c=document.querySelector("#y"),o=document.querySelector("#f"),r=document.querySelector("#b");async function i(){if(e)return{success:!0,publicKey:e};try{const t=await fetch("/api/getPublicKey",{method:"GET"}),n=await t.json();return e=n.publicKey,{success:!0,publicKey:e}}catch(e){return{success:!1,publicKey:null}}}function s(){return{key:window.forge.random.getBytesSync(32),iv:window.forge.random.getBytesSync(16)}}function u(e,t,n){const c=window.forge.cipher.createCipher("AES-CBC",t);return c.start({iv:n}),c.update(window.forge.util.createBuffer(e)),c.finish(),c.output.toHex()}function a(e,t){const n=window.forge.pki.publicKeyFromPem(t);return window.forge.util.encode64(n.encrypt(e,"RSA-OAEP"))}t.addEventListener("submit",(async function(e){e.preventDefault(),r.disabled=!0,r.textContent="Sending...";try{const e=n.value,r=c.value,y=o.value,l=await i();if(!l.success)throw new Error("Failed to fetch public key");const{key:d,iv:f}=s(),p=u(JSON.stringify({email:e,subject:r,message:y}),d,f),w=a(d,l.publicKey),g=a(f,l.publicKey),m=await fetch(t.action,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({encryptedPayload:p,encryptedKey:w,encryptedIv:g})}),b=await m.json();alert(b.message),"success"===b.status&&t.reset()}catch(e){alert("Something went wrong. Please try again.")}finally{r.disabled=!1,r.textContent="Send message"}}));