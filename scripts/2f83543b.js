let e="";const t=document.querySelector("#s"),c=document.querySelector("#o"),n=document.querySelector("#y"),r=document.querySelector("#f"),o=document.querySelector("#te"),i=document.querySelector("#z"),a=document.querySelector("#q");async function s(){if(e)return{success:!0,publicKey:e};try{const t=await fetch("/api/getPublicKey",{method:"GET"}),c=await t.json();return e=c.publicKey,{success:!0,publicKey:e}}catch(e){return{success:!1,publicKey:null}}}function u(){return{key:window.forge.random.getBytesSync(32),iv:window.forge.random.getBytesSync(16)}}function l(e,t,c){const n=window.forge.cipher.createCipher("AES-CBC",t);return n.start({iv:c}),n.update(window.forge.util.createBuffer(e)),n.finish(),n.output.toHex()}function d(e,t){const c=window.forge.pki.publicKeyFromPem(t);return window.forge.util.encode64(c.encrypt(e,"RSA-OAEP"))}t.addEventListener("submit",(async function(e){e.preventDefault(),i.classList.add("iw"),a.textContent="Sending...";try{const e=c.value,i=n.value,a=r.value,y=o.checked;if(i.length>100)return void alert("Subject cannot exceed 100 characters.");if(a.length>500)return void alert("Message cannot exceed 500 characters.");if(!y)return void alert("Please accept the Terms of Service and Privacy Policy before submitting.");const f=await s();if(!f.success)throw new Error("Failed to fetch public key");const{key:w,iv:g}=u(),m=l(JSON.stringify({email:e,subject:i,message:a}),w,g),p=d(w,f.publicKey),h=d(g,f.publicKey),S=await fetch(t.action,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:m+"."+p+"."+h})}),b=await S.json();alert(b.message),"success"===b.status&&t.reset()}catch(e){alert("Something went wrong. Please try again.")}finally{i.classList.remove("iw"),a.textContent="Send message"}}));